### **КОНФИГУРАЦИЯ.md**
# Система конфигурации Arcella (v0.2.4)

Этот документ описывает логику и поведение системы конфигурации Arcella, представленной в версии 0.2.4.

## 1. Базовая директория (`base_dir`)

Arcella определяет свою базовую директорию (`base_dir`) в соответствии со следующим порядком приоритета:

1.  **Проверка расположения бинарника**: Если бинарник Arcella находится в подкаталоге `bin`, родительская директория `bin` используется как `base_dir`.
2.  **Проверка локальной папки config**: Если каталог, из которого запущен бинарник Arcella, содержит подкаталог `config`, тогда сам каталог запуска используется как `base_dir`.
3.  **Резервный вариант (домашний каталог)**: Если ни одно из вышеуказанных условий не выполнено, используется системный домашний каталог пользователя, к которому добавляется `.arcella` (например, `~/.arcella` в Unix-подобных системах, `%USERPROFILE%\.arcella` в Windows).

Эта логика применима к различным операционным системам (Linux, AstraLinux, Windows, MacOS).

## 2. Каталог конфигурации (`config_dir`)

Каталог конфигурации всегда находится по пути `base_dir.join("config")`. Все основные конфигурационные файлы должны находиться в этом каталоге.

## 3. Основной конфигурационный файл (`arcella.toml`)

-   Arcella **создаёт** файл `arcella.toml` в `config_dir`, если он не существует, **копируя его из** `arcella.template.toml`.
-   Arcella **создаёт** файл `arcella.template.toml` в `config_dir`, если он не существует, **заполняя его встроенным шаблоном**.
-   Arcella **требует**, чтобы `arcella.toml` был **доступен для чтения**.
-   **Критически важно, что исполняемый файл Arcella *никогда* не должен изменять файл `arcella.toml` или `arcella.template.toml`.**

## 4. Загрузка составной конфигурации (реализация)

Arcella собирает единый объединённый объект конфигурации, рекурсивно объединяя содержимое из следующих источников в **порядке возрастания приоритета**:

1.  **Встроенный конфиг по умолчанию**: Значения, определённые в `default_config.toml` (встроенные в исполняемый файл).
2.  **Рекурсивно загруженные файлы из `includes`**: Файлы `.toml` (исключая `*.template.toml`), **указанные в массиве `includes`** в `arcella.toml` и других загруженных файлах, обрабатываются рекурсивно до `MAX_CONFIG_DEPTH` (включительно). Порядок файлов определяется лексикографическим порядком имён файлов и путей, а также порядком их указания в `includes`.

**Порядок слияния (от низшего к высшему приоритету):**
-   Сначала загружается **встроенный конфиг по умолчанию**.
-   Затем **рекурсивно загружаются и объединяются** файлы, найденные через `includes`.
-   Наконец, **применяется** `arcella.toml`.

**Механизм `#redef`:**
-   Если ключ в конфигурационном файле **оканчивается на `#redef`** (например, `arcella.log.level#redef = "debug"`), **значение для оригинального ключа** (`arcella.log.level`) **может быть переопределено** слоями конфигурации из `includes` ниже текущего.
-   Это позволяет файлу `arcella.toml` или встроенному конфигу по умолчанию **жёстко фиксировать** определённые значения, предотвращая их изменение через `includes`.
-   Если последующий слой конфигурации **пытается** установить значение для ключа, который был зафиксирован (т.е. не помечен как `#redef` в более приоритетном слое), **генерируется предупреждение** (`ValueError`), и **оригинальное значение сохраняется**.

**Ограничения на добавление новых ключей:**
-   Файлы, загруженные через `includes`, **могут вводить новые ключи только в разделах `arcella.custom` и `arcella.modules`**.
-   Попытка добавить новый ключ в другие разделы (например, `arcella.server.name`, если `name` отсутствует в более приоритетных слоях) **игнорируется** и вызывает предупреждение.

**Встроенный конфиг по умолчанию**
-   Задаёт значения по умолчанию для всех параметров конфигурации.
-   В разделе `includes` **встроенного конфига по умолчанию** указан только файл `arcella.toml`.
-   Файлы, загруженные через `includes`, могут дополнять параметры **встроенного конфига по умолчанию** только в разделах `arcella.custom` и `arcella.modules`.

**Итог:** Результирующий объект конфигурации строится таким образом, что **встроенный конфиг по умолчанию** определяет базовые значения, которые могут быть *дополнены или переопределены* (если используется `#redef`) значениями из файлов, указанных в `includes`, и **окончательно уточнены** содержимым `arcella.toml`.

## 5. Проверка целостности конфигурации

-   При запуске Arcella **инициализирует** `IntegrityChecker`, передав ему список файлов, которые нужно отслеживать.
-   В **текущей реализации** список файлов для проверки целостности (`integrity_check_paths`) в `ArcellaConfig` **инициализируется** только файлом `arcella.toml`.
-   Это означает, что **проверка целостности файлов конфигурации** в текущей версии реализуется только в отношении основного файла конфигурации.
-   В будущем, `integrity_check_paths` может быть **заполнен** путями к файлам, загруженным через `includes`.

## 6. StorageManager и каталоги

-   `StorageManager` **не** создаёт и **не** изменяет разрешения на `base_dir`, `config_dir` и `log`. Он **только** проверяет их корректность (например, доступность для чтения, запись в подкаталоги).
-   `StorageManager` **создаёт** следующие подкаталоги внутри `base_dir`, если они не существуют:
    -   `cache_dir`
    -   `modules_dir`

## 7. Последовательность инициализации (реализация)

Загрузка конфигурации и настройка каталогов происходят в строгой последовательности:

1.  **Определение `base_dir`**: Вызывается `fs_utils::find_base_dir()`.
2.  **Определение `config_dir`**: `base_dir.join("config")`.
3.  **Обеспечение существования `config_dir` и файлов `arcella.toml`/`arcella.template.toml`**: Вызывается `ensure_config_template(&config_dir)`.
4.  **Загрузка конфигов**: Вызывается `arcella_fs_utils::load_config_recursive_from_content` с `DEFAULT_CONFIG_CONTENT`, `arcella.toml` и `includes`.
5.  **Слияние слоёв с учётом `#redef`**: Выполняется логика объединения `configs` в `final_values`.
6.  **Извлечение, сортировка и индексирование параметров**: Выполняется создание объекта `arcella_types::value::ConfigData`.
7.  **Создание `ArcellaConfig`**: Создаётся и возвращается структура `ArcellaConfig` с извлечёнными ключевыми значениями.
8.  **Инициализация логирования**: Система логирования инициализируется с использованием `ArcellaConfig` и создаёт `log_dir`.
9.  **Создание других каталогов**: `StorageManager` создаёт `cache_dir` и `modules_dir` на основе `ArcellaConfig`.

## 8. Логирование

-   До старта основной системы логирования все ошибки и предупреждения собираются в `warnings`.
-   После запуска основной системы логирования все события из `warnings` передаются в основной логгер.
-   Если при запуске основной системы логирования или сборке конфигурации произошла критическая ошибка, то `warnings` выгружается в консоль и файл `init.log`.

## 9. Предупреждения о переопределении

Если процесс загрузки конфигурации обнаруживает попытку переопределить пару ключ-значение, которая уже была определена источником более высокого приоритета (в частности, если ключ в более раннем слое не имеет `#redef`), Arcella **выдаст предупреждение** (`ConfigLoadWarning::ValueError`), которое **собирается** в вектор `warnings`. Значение из источника более высокого приоритета сохраняется.

---

### 📄 **Пример, иллюстрирующий слияние конфигураций**

#### 1. `default_config.toml` (встроенный, слой 0)

```toml
[arcella.log]
level = "info"
file = "arcella_default.log"

[arcella.server]
port = 8080
host = "0.0.0.0"

includes = ["arcella.toml"]
```

#### 2. `arcella.toml`

```toml
[arcella.log]
level#redef = "warn"  # Разрешает переопределение уровня логирования через includes
file = "arcella_main.log"  # Переопределяет значение из default_config.toml

[arcella.server]
port = 9000  # Переопределяет порт из default_config.toml
# host не указан → остаётся "0.0.0.0"
```

#### 3. `level_1.toml` (из `includes`, слой 1)

```toml
[arcella.log]
level = "debug"  # Успешно переопределяет "warn", так как level помечен как #redef в arcella.toml

[arcella.server]
host = "127.0.0.1"  # Игнорируется: ключ 'arcella.server.host' не помечен как #redef в более приоритетных слоях
name = "www.server.net"  # Игнорируется: новый ключ вне разделов arcella.custom/arcella.modules

[arcella.custom]
message = "Это дополнительный параметр"  # Разрешено: раздел arcella.custom допускает новые ключи
```

#### Итоговая конфигурация

```toml
[arcella.log]
level = "debug"
file = "arcella_main.log"

[arcella.server]
port = 9000
host = "0.0.0.0"

[arcella.custom]
message = "Это дополнительный параметр"
```
