### **КОНФИГУРАЦИЯ.md**

# Система конфигурации Arcella

Этот документ описывает логику и поведение системы конфигурации Arcella, представленной в версии 0.2.4.

## 1. Базовая директория (`base_dir`)

Arcella определяет свою базовую директорию (`base_dir`) в соответствии со следующим порядком приоритета:

1.  **Проверка расположения бинарника**: Если бинарник Arcella находится в подкаталоге `bin`, родительская директория `bin` используется как `base_dir`.
2.  **Проверка локальной папки config**: Если каталог, из которого запущен бинарник Arcella, содержит подкаталог `config`, тогда сам каталог запуска используется как `base_dir`.
3.  **Резервный вариант (домашний каталог)**: Если ни одно из вышеуказанных условий не выполнено, используется системный домашний каталог пользователя, к которому добавляется `.arcella` (например, `~/.arcella` в Unix-подобных системах, `%USERPROFILE%\.arcella` в Windows).

Эта логика применима к различным операционным системам (Linux, AstraLinux, Windows, MacOS).

## 2. Каталог конфигурации (`config_dir`)

Каталог конфигурации всегда находится по пути `base_dir.join("config")`. Все основные конфигурационные файлы должны находиться в этом каталоге.

## 3. Основной конфигурационный файл (`arcella.toml`)

-   Arcella требует наличия основного конфигурационного файла с именем `arcella.toml` в `config_dir`.
-   Если `arcella.toml` не найден, Arcella завершит работу с ошибкой.
-   Если подкаталог `config_template` не существует внутри `config_dir`, Arcella создаст его и сгенерирует в нем файл шаблона `arcella.template.toml`. Этот шаблон служит примером для пользователя.
-   **Критически важно, что исполняемый файл Arcella *никогда* не будет изменять файл `arcella.toml`.**

## 4. Загрузка составной конфигурации

Arcella собирает единый объединенный объект конфигурации, объединяя содержимое из нескольких источников в определенном порядке приоритета. Источники более низкого приоритета дополняют, но *не* переопределяют источники более высокого приоритета.

Порядок объединения:

1.  **`arcella.toml`**: Содержимое основного конфигурационного файла.
2.  **Явные файлы**: Содержимое всех файлов `.toml`, перечисленных в `arcella.toml` (под определенным ключом конфигурации, например, `includes.files`) и находящихся в `config_dir`.
3.  **Явные каталоги**: Содержимое всех файлов `.toml`, найденных в подкаталогах `config_dir`. Названия этих подкаталогов должны быть перечислены в `arcella.toml` (под определенным ключом конфигурации, например, `includes.dirs`).

**Правила:**

-   Файлы с именем `*.template.toml` **исключаются** из объединения конфигурации, даже если они явно указаны в `arcella.toml`.
-   Максимальная глубина исследования подкаталогов внутри `config_dir` ограничена 3 уровнями, как определено в `arcella.toml`.

## 5. Проверка целостности конфигурации

-   При запуске Arcella выполняет **однократную** проверку целостности файлов базовой конфигурации (`arcella.toml` и любых файлов, явно включенных из `config_dir` согласно `arcella.toml`).
-   Эта проверка выявляет, были ли эти файлы изменены с момента запуска Arcella (например, путем сравнения времени модификации файлов или контрольных сумм).
-   Если обнаружено какое-либо изменение, Arcella завершит работу немедленно с сообщением об ошибке безопасности. Это предотвращает возможное вмешательство в основную конфигурацию во время выполнения.
-   В `arcella.toml` можно опционально указать *дополнительные* файлы или каталоги, которые также будут включены в проверку целостности.

## 6. StorageManager и каталоги

-   `StorageManager` **не** создает и **не** изменяет разрешения на `base_dir` или `config_dir`. Он **только** проверяет их корректность (например, доступность для чтения, запись в подкаталоги).
-   `StorageManager` **создает** следующие подкаталоги внутри `base_dir`, если они не существуют:
    -   `log`
    -   `cache`
    -   `modules`

## 7. Последовательность инициализации

Загрузка конфигурации и настройка каталогов происходят в строгой последовательности:

1.  **Загрузка конфигов**: Все конфигурационные файлы считываются и объединяются в соответствии с описанными выше правилами.
2.  **Создание каталога логов**: Создается подкаталог `log` внутри `base_dir`.
3.  **Инициализация логирования**: Система логирования инициализируется с использованием загруженной конфигурации.
4.  **Создание других каталогов**: Создаются подкаталоги `cache` и `modules`.

## 8. Предупреждения о переопределении

Если процесс загрузки конфигурации обнаруживает попытку переопределить пару ключ-значение, которая уже была определена источником более высокого приоритета, Arcella выдаст **предупреждение** через систему логирования. Значение из источника более высокого приоритета сохраняется.