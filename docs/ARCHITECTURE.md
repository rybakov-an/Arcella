# Arcella: Modular WebAssembly Runtime  
**Легковесный, безопасный и динамичный runtime для компонентов WebAssembly**  
*Вдохновлено OSGi и Apache Karaf • Построено на Wasmtime*

---

## 🎯 Цель

Создать **модульный контейнер времени выполнения**, в котором можно:

- Динамически загружать `.wasm`-компоненты  
- Управлять их жизненным циклом (`install`, `start`, `stop`, `update`, `remove`)  
- Обеспечивать **изоляцию и безопасность по умолчанию**  
- Позволять компонентам взаимодействовать через **типобезопасные интерфейсы**  
- Предоставлять **CLI/Shell** для администрирования
- Поддерживать **переносимые компоненты**: модуль описывает *что он делает*, а среда — *как его запускать*  
- Разделять **компонентный манифест** (интерфейсы, метаданные) и **развёртывочный профиль** (изоляция, доверие, группа)

---

## 🧩 Ключевые принципы архитектуры

1. **Arcella всегда работает как демон**  
2. **Гибридная модель изоляции**:  
   - Доверенные async-модули — в основном tokio-потоке  
   - Недоверенные или sync-модули — в изолированных `arcella-worker` процессах  
3. **Группировка модулей** в worker’ы для эффективного использования ресурсов  
4. **Единая точка управления** через ALME (Arcella Local Management Extensions)  
5. **Поддержка как синхронных (WASI), так и асинхронных (Component Model + WIT) модулей**
6. **Чёткое разделение описания компонента и политики его выполнения**
---

## 🏗️ Общая архитектура

```
┌───────────────────────────────────────────────────────┐
│                  Arcella (main process)               │
│                                                       │
│  ┌─────────────┐     ┌───────────────────────────┐   │
│  │   ALME      │◄───►│      ArcellaRuntime       │   │
│  │ (Unix sock) │     └─────────────┬─────────────┘   │
│  └─────────────┘                   │                 │
│                                    │                 │
│  ┌────────────────────────────────▼─────────────┐   │
│  │           Trusted Async Modules              │   │
│  │  (запускаются напрямую в основном потоке)    │   │
│  └──────────────────────────────────────────────┘   │
│                                    │                 │
│  ┌────────────────────────────────▼─────────────┐   │
│  │            WorkerManager                     │   │
│  └───────┬───────────────────────┬──────────────┘   │
│          │                       │                  │
│  ┌───────▼──────┐        ┌───────▼──────┐          │
│  │ arcella-     │        │ arcella-     │          │
│  │ worker       │        │ worker       │          │
│  │ (group=core) │        │ (group=ext)  │          │
│  └───────┬──────┘        └───────┬──────┘          │
│          │                       │                  │
│  ┌───────▼──────┐        ┌───────▼──────┐          │
│  │ Module A     │        │ Module X     │          │
│  │ Module B     │        │ Module Y     │          │
│  └──────────────┘        └──────────────┘          │
└─────────────────────────────────────────────────────┘
```

---

### 📦 Манифесты: компонентный и развёртывочный

Arcella использует **два независимых манифеста** (файла конфигурации), разделяющих **описание модуля** и **политику его выполнения**.

### 1. **Компонентный манифест** (`component.toml`)
Описывает **сам модуль** — его интерфейсы, зависимости и метаданные. Этот файл:
- Является **частью дистрибутива модуля**,
- Может быть **опущен** для WebAssembly Component Model (интерфейсы извлекаются из `.wasm`),
- **Обязателен** для WASI-модулей (у них нет встроенных интерфейсов).

Пример (`component.toml`):
```toml
[component]
name = "http-logger"
version = "0.1.0"
description = "Logs HTTP requests"
exports = ["logger:log@1.0"]
imports = ["wasi:http/incoming-handler@0.2.0"]
```

### 2. **Развёртывочный профиль** (`deployment.toml`)
Описывает **как запускать модуль в конкретной среде**. Этот файл:
- **Не поставляется с модулем**,
- Создаётся **администратором** при установке,
- Управляет изоляцией, доверием и ресурсами.

Пример (`deployment.toml`):
```toml
[deployment]
isolation = "worker"
trusted = false
async = true
group = "web"

[startup]
entrypoint = "start"
shutdown = "stop"
```

> 💡 **Преимущество**: один и тот же `.wasm` + `component.toml` можно развернуть в dev-среде (`isolation = "main"`) и prod (`isolation = "worker"`), просто изменив `deployment.toml`.
---

## 🔌 Механизмы взаимодействия

| Сценарий | Механизм | Протокол |
|--------|--------|--------|
| **Main ↔ Main** | Прямые вызовы через `Arc<RwLock<...>>` или `tokio::sync::mpsc` | Rust-типы (zero-cost) |
| **Main ↔ Worker** | IPC через Unix-сокет или stdin/stdout | MessagePack / JSON / Cap’n Proto |
| **Worker ↔ Worker** | Только через Main (рекомендуется) или прямой сокет (опционально) | Тот же, что Main ↔ Worker |

> 💡 Все интерфейсы между модулями **описываются в WIT** и генерируются через `wit-bindgen`.

---

## 🧱 Структура проекта

```
arcella/                              # Корень проекта (workspace)
│
├── Cargo.toml                        # [workspace] — объединяет все crate'ы
├── README.md
├── LICENSE-APACHE
├── LICENSE-MIT
│
├── alme-proto/                       # 📦 Общий crate: протокол ALME
│   ├── Cargo.toml
│   └── src/
│       └── lib.rs                    # AlmeRequest, AlmeResponse
│
├── arcella/                          # 🧠 Основной демон (runtime)
│   ├── Cargo.toml
│   └── src/
│       ├── main.rs                   # Точка входа демона
│       ├── lib.rs                    # Экспорт общих частей (опционально)
│       ├── alme/                     # ALME-сервер
│       ├── runtime/                  # Основной runtime, управление модулями
│       ├── config/                   # Загрузка конфигурации (~/.arcella/cfg/)
│       ├── storage/                  # Работа с файлами (~/.arcella/modules/)
│       ├── cache/                    # Кэширование скомпилированных модулей
│       ├── manifest/                 # Парсинг и валидация component.toml и deployment.toml
│       ├── log/                      # Инициализация трассировки
│       └── error/                    # Общие типы ошибок
│
├── arcella-cli/                      # 🖥️ CLI-клиент (управление через ALME)
│   ├── Cargo.toml
│   └── src/
│       └── main.rs                   # Точка входа CLI
│
├── bin/
│   └── arcella-worker.rs             # Отдельный бинарник для изолированных модулей
│
└── docs/
    ├── ARCHITECTURE.md
    └── ...                           # Другая документация
```

---

## ⚙️ Компоненты

### 1. **ALME (Arcella Local Management Extensions)**
- Unix-сокет: `~/.arcella/alme`
- Принимает команды: `install`, `start`, `stop`, `list`, `status`
- Возвращает JSON-RPC-подобные ответы
- Единственная точка управления runtime’ом

### 2. **ArcellaRuntime**
Центральный оркестратор:
- Хранит карту всех модулей (`HashMap<id, InstalledModule>`)
- Управляет жизненным циклом
- Создаёт экземпляры в `main` или делегирует в `WorkerManager`

### 3. **WorkerManager**
- Запускает/останавливает процессы `arcella-worker`
- Группирует модули по имени группы
- Обеспечивает IPC с дочерними процессами

### 4. **arcella-worker (отдельный бинарник)**
- Принимает команды от родителя через IPC
- Использует **общий `wasmtime::Engine`** для всех модулей в группе
- Поддерживает `install`, `start`, `stop` внутри процесса
- Может быть синхронным или асинхронным (в зависимости от модулей)

### 5. **Trusted Async Module (в основном потоке)**
- Запускается только если `trusted = true && async = true`
- Использует `wasmtime` в **async-режиме**
- Имеет прямой доступ к другим доверенным модулям
- Поддерживает таймауты и graceful shutdown через `tokio::time::timeout`

---

## 🔒 Безопасность и отказоустойчивость

| Угроза | Защита |
|-------|--------|
| Бесконечный цикл | `store.set_fuel(N)` + ловля `Trap` |
| Блокирующий I/O | Запуск в `worker` + таймаут на IPC |
| Аварийное завершение модуля | Изоляция в процессе → не влияет на демон |
| Утечка памяти | Ограничение памяти через `Config::static_memory_maximum_size()` |
| Недоверенный код | Только в `worker`, без доступа к основному процессу |

---

## 🚀 Жизненный цикл модуля

1. **`install`**  
   - Копирование `.wasm` и `component.toml` (если есть) в `~/.arcella/modules/<id>/`  
   - Применение `deployment.toml` (предоставленного при установке)  
   - Валидация совместимости компонента и профиля  
   - Регистрация в `ArcellaRuntime`

2. **`start`**  
   - Если `isolation = "main"` → запуск в основном потоке  
   - Если `isolation = "worker"` → отправка команды в соответствующий `arcella-worker`

3. **`stop`**  
   - Отправка сигнала остановки  
   - Ожидание graceful shutdown (с таймаутом)  
   - Принудительное завершение процесса (если worker)

4. **`update` / `remove`**  
   - Остановка → замена файла → перезапуск (для `update`)

---

## 📅 Дорожная карта (MVP)

| Версия | Фича |
|-------|------|
| v0.1 | Запуск простого WASI-модуля (sync) |
| v0.2 | ALME через Unix-сокет |
| v0.2.1 | Внутреннее логирование |
| v0.2.2 | CLI-консоль через ALME |
| v0.2.3 | Манифесты жизненного цикла + WIT |
| v0.2.4 | Загрузка конфигурации из файлов |
| v0.2.5 | Управление жизненным циклом через ALME |
| v0.2.6 | Межкомпонентное взаимодействи + извлечение WIT из `.wasm` |
| v0.3.0 | Горячее обновление + базовая безопасность + гибридная изоляция |

---

## 🛠 Технологии

- **Язык хоста**: Rust 1.90+  
- **WASM Engine**: `wasmtime` v37+  
- **CLI**: `clap`  
- **Async Runtime**: `tokio`  
- **Сериализация**: `serde` + `serde_json` / `rmp-serde`  
- **Логирование**: `tracing` + `tracing-subscriber`  
- **Ошибки**: `thiserror`  
- **Пути**: `dirs`  
- **Парсинг конфигов**: `toml`, `regex`

---

## ✅ Преимущества архитектуры

- **Безопасность по умолчанию**: недоверенный код изолирован  
- **Высокая производительность**: доверенные модули без IPC  
- **Эффективность ресурсов**: группировка в worker’ы  
- **Гибкость**: выбор стратегии на уровне модуля  
- **Совместимость**: поддержка WASI, Component Model, sync/async  
- **Управляемость**: единый ALME-интерфейс для всех операций
- **Переносимость компонентов**: модуль не привязан к среде выполнения — политика развёртывания задаётся отдельно
---

> **Arcella — это не просто WASM-рантайм, а операционная среда для компонентов следующего поколения.**
