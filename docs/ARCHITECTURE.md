# Arcella: Modular WebAssembly Runtime  
**ะะตะณะบะพะฒะตัะฝัะน, ะฑะตะทะพะฟะฐัะฝัะน ะธ ะดะธะฝะฐะผะธัะฝัะน runtime ะดะปั ะบะพะผะฟะพะฝะตะฝัะพะฒ WebAssembly**  
*ะะดะพัะฝะพะฒะปะตะฝะพ OSGi ะธ Apache Karaf โข ะะพัััะพะตะฝะพ ะฝะฐ Wasmtime*

---

## ๐ฏ ะฆะตะปั

ะกะพะทะดะฐัั **ะผะพะดัะปัะฝัะน ะบะพะฝัะตะนะฝะตั ะฒัะตะผะตะฝะธ ะฒัะฟะพะปะฝะตะฝะธั**, ะฒ ะบะพัะพัะพะผ ะผะพะถะฝะพ:

- ะะธะฝะฐะผะธัะตัะบะธ ะทะฐะณััะถะฐัั `.wasm`-ะบะพะผะฟะพะฝะตะฝัั  
- ะฃะฟัะฐะฒะปััั ะธั ะถะธะทะฝะตะฝะฝัะผ ัะธะบะปะพะผ (`install`, `start`, `stop`, `update`, `remove`)  
- ะะฑะตัะฟะตัะธะฒะฐัั **ะธะทะพะปััะธั ะธ ะฑะตะทะพะฟะฐัะฝะพััั ะฟะพ ัะผะพะปัะฐะฝะธั**  
- ะะพะทะฒะพะปััั ะบะพะผะฟะพะฝะตะฝัะฐะผ ะฒะทะฐะธะผะพะดะตะนััะฒะพะฒะฐัั ัะตัะตะท **ัะธะฟะพะฑะตะทะพะฟะฐัะฝัะต ะธะฝัะตััะตะนัั**  
- ะัะตะดะพััะฐะฒะปััั **CLI/Shell** ะดะปั ะฐะดะผะธะฝะธัััะธัะพะฒะฐะฝะธั  

---

## ๐งฉ ะะปััะตะฒัะต ะฟัะธะฝัะธะฟั ะฐััะธัะตะบัััั

1. **Arcella ะฒัะตะณะดะฐ ัะฐะฑะพัะฐะตั ะบะฐะบ ะดะตะผะพะฝ**  
2. **ะะธะฑัะธะดะฝะฐั ะผะพะดะตะปั ะธะทะพะปััะธะธ**:  
   - ะะพะฒะตัะตะฝะฝัะต async-ะผะพะดัะปะธ โ ะฒ ะพัะฝะพะฒะฝะพะผ tokio-ะฟะพัะพะบะต  
   - ะะตะดะพะฒะตัะตะฝะฝัะต ะธะปะธ sync-ะผะพะดัะปะธ โ ะฒ ะธะทะพะปะธัะพะฒะฐะฝะฝัั `arcella-worker` ะฟัะพัะตััะฐั  
3. **ะััะฟะฟะธัะพะฒะบะฐ ะผะพะดัะปะตะน** ะฒ workerโั ะดะปั ัััะตะบัะธะฒะฝะพะณะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ัะตััััะพะฒ  
4. **ะะดะธะฝะฐั ัะพัะบะฐ ัะฟัะฐะฒะปะตะฝะธั** ัะตัะตะท ALME (Arcella Local Management Extensions)  
5. **ะะพะดะดะตัะถะบะฐ ะบะฐะบ ัะธะฝััะพะฝะฝัั (WASI), ัะฐะบ ะธ ะฐัะธะฝััะพะฝะฝัั (Component Model + WIT) ะผะพะดัะปะตะน**

---

## ๐๏ธ ะะฑัะฐั ะฐััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  Arcella (main process)               โ
โ                                                       โ
โ  โโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ   ALME      โโโโโโบโ      ArcellaRuntime       โ   โ
โ  โ (Unix sock) โ     โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโ   โ
โ  โโโโโโโโโโโโโโโ                   โ                 โ
โ                                    โ                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโ   โ
โ  โ           Trusted Async Modules              โ   โ
โ  โ  (ะทะฐะฟััะบะฐัััั ะฝะฐะฟััะผัั ะฒ ะพัะฝะพะฒะฝะพะผ ะฟะพัะพะบะต)    โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                    โ                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโ   โ
โ  โ            WorkerManager                     โ   โ
โ  โโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโ   โ
โ          โ                       โ                  โ
โ  โโโโโโโโโผโโโโโโโ        โโโโโโโโโผโโโโโโโ          โ
โ  โ arcella-     โ        โ arcella-     โ          โ
โ  โ worker       โ        โ worker       โ          โ
โ  โ (group=core) โ        โ (group=ext)  โ          โ
โ  โโโโโโโโโฌโโโโโโโ        โโโโโโโโโฌโโโโโโโ          โ
โ          โ                       โ                  โ
โ  โโโโโโโโโผโโโโโโโ        โโโโโโโโโผโโโโโโโ          โ
โ  โ Module A     โ        โ Module X     โ          โ
โ  โ Module B     โ        โ Module Y     โ          โ
โ  โโโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโ          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฆ ะขะธะฟั ะผะพะดัะปะตะน ะธ ะธะทะพะปััะธั

ะะฐะถะดัะน ะผะพะดัะปั ะพะฟะธััะฒะฐะตััั ะฒ **ะผะฐะฝะธัะตััะต** (`arcella.toml`) ะธ ะผะพะถะตั ะธัะฟะพะปัะทะพะฒะฐัั ะพะดะธะฝ ะธะท ัะตะถะธะผะพะฒ ะธะทะพะปััะธะธ:

| ะะพะปะต ะผะฐะฝะธัะตััะฐ | ะะฝะฐัะตะฝะธะต | ะะฟะธัะฐะฝะธะต |
|----------------|--------|--------|
| `isolation` | `"main"` | ะะฐะฟััะบ ะฒ ะพัะฝะพะฒะฝะพะผ tokio-ะฟะพัะพะบะต Arcella |
| | `"worker"` | ะะฐะฟััะบ ะฒ ะพัะดะตะปัะฝะพะผ ะฟัะพัะตััะต `arcella-worker` |
| `trusted` | `true`/`false` | ะขะพะปัะบะพ `true` ัะฐะทัะตัะตะฝะพ ะดะปั `isolation = "main"` |
| `async` | `true`/`false` | ะขัะตะฑัะตััั `true` ะดะปั `isolation = "main"` |
| `group` | ัััะพะบะฐ | ะะผั ะณััะฟะฟั ะดะปั worker-ัะตะถะธะผะฐ (ะผะพะดัะปะธ ะฒ ะพะดะฝะพะน ะณััะฟะฟะต ะดะตะปัั ัะตััััั) |

### ะัะธะผะตั ะผะฐะฝะธัะตััะฐ
```toml
[module]
name = "http-logger"
version = "0.1.0"
isolation = "main"
trusted = true
async = true
exports = ["logger:log"]
imports = ["wasi:http/incoming-handler@0.2.0"]
```

---

## ๐ ะะตัะฐะฝะธะทะผั ะฒะทะฐะธะผะพะดะตะนััะฒะธั

| ะกัะตะฝะฐัะธะน | ะะตัะฐะฝะธะทะผ | ะัะพัะพะบะพะป |
|--------|--------|--------|
| **Main โ Main** | ะััะผัะต ะฒัะทะพะฒั ัะตัะตะท `Arc<RwLock<...>>` ะธะปะธ `tokio::sync::mpsc` | Rust-ัะธะฟั (zero-cost) |
| **Main โ Worker** | IPC ัะตัะตะท Unix-ัะพะบะตั ะธะปะธ stdin/stdout | MessagePack / JSON / Capโn Proto |
| **Worker โ Worker** | ะขะพะปัะบะพ ัะตัะตะท Main (ัะตะบะพะผะตะฝะดัะตััั) ะธะปะธ ะฟััะผะพะน ัะพะบะตั (ะพะฟัะธะพะฝะฐะปัะฝะพ) | ะขะพั ะถะต, ััะพ Main โ Worker |

> ๐ก ะัะต ะธะฝัะตััะตะนัั ะผะตะถะดั ะผะพะดัะปัะผะธ **ะพะฟะธััะฒะฐัััั ะฒ WIT** ะธ ะณะตะฝะตัะธัััััั ัะตัะตะท `wit-bindgen`.

---

## ๐งฑ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
arcella/
โโโ Cargo.toml
โโโ src/
โ   โโโ main.rs                 # ะขะพัะบะฐ ะฒัะพะดะฐ ะดะตะผะพะฝะฐ
โ   โโโ cli/                    # CLI-ะฟะฐััะตั (arcella shell, install ะธ ั.ะด.)
โ   โโโ alme/                   # ALME: Unix-ัะพะบะตั ัะตัะฒะตั ะธ ะฟัะพัะพะบะพะป
โ   โโโ runtime/                # ะัะฝะพะฒะฝะพะน runtime, ัะฟัะฐะฒะปะตะฝะธะต ะผะพะดัะปัะผะธ
โ   โโโ worker/                 # ะฃะฟัะฐะฒะปะตะฝะธะต arcella-worker ะฟัะพัะตััะฐะผะธ
โ   โโโ config/                 # ะะฐะณััะทะบะฐ ะบะพะฝัะธะณััะฐัะธะธ (~/.arcella/cfg/)
โ   โโโ storage/                # ะะฐะฑะพัะฐ ั ัะฐะนะปะฐะผะธ (~/.arcella/modules/)
โ   โโโ cache/                  # ะััะธัะพะฒะฐะฝะธะต ัะบะพะผะฟะธะปะธัะพะฒะฐะฝะฝัั ะผะพะดัะปะตะน
โ   โโโ manifest/               # ะะฐััะธะฝะณ arcella.toml ะธ ะฒะฐะปะธะดะฐัะธั
โ   โโโ log/                    # ะะฝะธัะธะฐะปะธะทะฐัะธั ััะฐััะธัะพะฒะบะธ
โ   โโโ error.rs                # ะะฑัะธะต ัะธะฟั ะพัะธะฑะพะบ
โ
โโโ bin/
โ   โโโ arcella-worker.rs       # ะัะดะตะปัะฝัะน ะฑะธะฝะฐัะฝะธะบ ะดะปั ะธะทะพะปะธัะพะฒะฐะฝะฝัั ะผะพะดัะปะตะน
โ
โโโ docs/
    โโโ ARCHITECTURE.md         # ะญัะพั ะดะพะบัะผะตะฝั
```

---

## โ๏ธ ะะพะผะฟะพะฝะตะฝัั

### 1. **ALME (Arcella Local Management Extensions)**
- Unix-ัะพะบะตั: `~/.arcella/alme`
- ะัะธะฝะธะผะฐะตั ะบะพะผะฐะฝะดั: `install`, `start`, `stop`, `list`, `status`
- ะะพะทะฒัะฐัะฐะตั JSON-RPC-ะฟะพะดะพะฑะฝัะต ะพัะฒะตัั
- ะะดะธะฝััะฒะตะฝะฝะฐั ัะพัะบะฐ ัะฟัะฐะฒะปะตะฝะธั runtimeโะพะผ

### 2. **ArcellaRuntime**
ะฆะตะฝััะฐะปัะฝัะน ะพัะบะตัััะฐัะพั:
- ะฅัะฐะฝะธั ะบะฐััั ะฒัะตั ะผะพะดัะปะตะน (`HashMap<id, ModuleLocation>`)
- ะฃะฟัะฐะฒะปัะตั ะถะธะทะฝะตะฝะฝัะผ ัะธะบะปะพะผ
- ะกะพะทะดะฐัั ัะบะทะตะผะฟะปััั ะฒ `main` ะธะปะธ ะดะตะปะตะณะธััะตั ะฒ `WorkerManager`

### 3. **WorkerManager**
- ะะฐะฟััะบะฐะตั/ะพััะฐะฝะฐะฒะปะธะฒะฐะตั ะฟัะพัะตััั `arcella-worker`
- ะััะฟะฟะธััะตั ะผะพะดัะปะธ ะฟะพ ะธะผะตะฝะธ ะณััะฟะฟั
- ะะฑะตัะฟะตัะธะฒะฐะตั IPC ั ะดะพัะตัะฝะธะผะธ ะฟัะพัะตััะฐะผะธ

### 4. **arcella-worker (ะพัะดะตะปัะฝัะน ะฑะธะฝะฐัะฝะธะบ)**
- ะัะธะฝะธะผะฐะตั ะบะพะผะฐะฝะดั ะพั ัะพะดะธัะตะปั ัะตัะตะท IPC
- ะัะฟะพะปัะทัะตั **ะพะฑัะธะน `wasmtime::Engine`** ะดะปั ะฒัะตั ะผะพะดัะปะตะน ะฒ ะณััะฟะฟะต
- ะะพะดะดะตัะถะธะฒะฐะตั `install`, `start`, `stop` ะฒะฝัััะธ ะฟัะพัะตััะฐ
- ะะพะถะตั ะฑััั ัะธะฝััะพะฝะฝัะผ ะธะปะธ ะฐัะธะฝััะพะฝะฝัะผ (ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ะผะพะดัะปะตะน)

### 5. **Trusted Async Module (ะฒ ะพัะฝะพะฒะฝะพะผ ะฟะพัะพะบะต)**
- ะะฐะฟััะบะฐะตััั ัะพะปัะบะพ ะตัะปะธ `trusted = true && async = true`
- ะัะฟะพะปัะทัะตั `wasmtime` ะฒ **async-ัะตะถะธะผะต**
- ะะผะตะตั ะฟััะผะพะน ะดะพัััะฟ ะบ ะดััะณะธะผ ะดะพะฒะตัะตะฝะฝัะผ ะผะพะดัะปัะผ
- ะะพะดะดะตัะถะธะฒะฐะตั ัะฐะนะผะฐััั ะธ graceful shutdown ัะตัะตะท `tokio::time::timeout`

---

## ๐ ะะตะทะพะฟะฐัะฝะพััั ะธ ะพัะบะฐะทะพัััะพะนัะธะฒะพััั

| ะฃะณัะพะทะฐ | ะะฐัะธัะฐ |
|-------|--------|
| ะะตัะบะพะฝะตัะฝัะน ัะธะบะป | `store.set_fuel(N)` + ะปะพะฒะปั `Trap` |
| ะะปะพะบะธััััะธะน I/O | ะะฐะฟััะบ ะฒ `worker` + ัะฐะนะผะฐัั ะฝะฐ IPC |
| ะะฒะฐัะธะนะฝะพะต ะทะฐะฒะตััะตะฝะธะต ะผะพะดัะปั | ะะทะพะปััะธั ะฒ ะฟัะพัะตััะต โ ะฝะต ะฒะปะธัะตั ะฝะฐ ะดะตะผะพะฝ |
| ะฃัะตัะบะฐ ะฟะฐะผััะธ | ะะณัะฐะฝะธัะตะฝะธะต ะฟะฐะผััะธ ัะตัะตะท `Config::static_memory_maximum_size()` |
| ะะตะดะพะฒะตัะตะฝะฝัะน ะบะพะด | ะขะพะปัะบะพ ะฒ `worker`, ะฑะตะท ะดะพัััะฟะฐ ะบ ะพัะฝะพะฒะฝะพะผั ะฟัะพัะตััั |

---

## ๐ ะะธะทะฝะตะฝะฝัะน ัะธะบะป ะผะพะดัะปั

1. **`install`**  
   - ะะพะฟะธัะพะฒะฐะฝะธะต `.wasm` ะฒ `~/.arcella/modules/`  
   - ะะฐััะธะฝะณ `arcella.toml`  
   - ะะตะณะธัััะฐัะธั ะฒ `ArcellaRuntime`

2. **`start`**  
   - ะัะปะธ `isolation = "main"` โ ะทะฐะฟััะบ ะฒ ะพัะฝะพะฒะฝะพะผ ะฟะพัะพะบะต  
   - ะัะปะธ `isolation = "worker"` โ ะพัะฟัะฐะฒะบะฐ ะบะพะผะฐะฝะดั ะฒ ัะพะพัะฒะตัััะฒัััะธะน `arcella-worker`

3. **`stop`**  
   - ะัะฟัะฐะฒะบะฐ ัะธะณะฝะฐะปะฐ ะพััะฐะฝะพะฒะบะธ  
   - ะะถะธะดะฐะฝะธะต graceful shutdown (ั ัะฐะนะผะฐััะพะผ)  
   - ะัะธะฝัะดะธัะตะปัะฝะพะต ะทะฐะฒะตััะตะฝะธะต ะฟัะพัะตััะฐ (ะตัะปะธ worker)

4. **`update` / `remove`**  
   - ะััะฐะฝะพะฒะบะฐ โ ะทะฐะผะตะฝะฐ ัะฐะนะปะฐ โ ะฟะตัะตะทะฐะฟััะบ (ะดะปั `update`)

---

## ๐ ะะพัะพะถะฝะฐั ะบะฐััะฐ (MVP)

| ะะตััะธั | ะคะธัะฐ |
|-------|------|
| v0.1 | ะะฐะฟััะบ ะฟัะพััะพะณะพ WASI-ะผะพะดัะปั (sync) |
| v0.2 | ALME ัะตัะตะท Unix-ัะพะบะตั |
| v0.3 | CLI-ะบะพะฝัะพะปั ัะตัะตะท ALME |
| v0.4 | ะะฝัััะตะฝะฝะตะต ะปะพะณะธัะพะฒะฐะฝะธะต |
| v0.5 | ะะฐะฝะธัะตัั ะถะธะทะฝะตะฝะฝะพะณะพ ัะธะบะปะฐ + WIT |
| v0.6 | ะะฐะณััะทะบะฐ ะบะพะฝัะธะณััะฐัะธะธ ะธะท ัะฐะนะปะพะฒ |
| v0.7 | ะฃะฟัะฐะฒะปะตะฝะธะต ะถะธะทะฝะตะฝะฝัะผ ัะธะบะปะพะผ ัะตัะตะท ALME |
| v0.8 | ะะตะถะบะพะผะฟะพะฝะตะฝัะฝะพะต ะฒะทะฐะธะผะพะดะตะนััะฒะธะต |
| v1.0 | ะะพัััะตะต ะพะฑะฝะพะฒะปะตะฝะธะต + ะฑะฐะทะพะฒะฐั ะฑะตะทะพะฟะฐัะฝะพััั + ะณะธะฑัะธะดะฝะฐั ะธะทะพะปััะธั |

---

## ๐ ะขะตัะฝะพะปะพะณะธะธ

- **ะฏะทัะบ ัะพััะฐ**: Rust 1.90+  
- **WASM Engine**: `wasmtime` v37+  
- **CLI**: `clap`  
- **Async Runtime**: `tokio`  
- **ะกะตัะธะฐะปะธะทะฐัะธั**: `serde` + `serde_json` / `rmp-serde`  
- **ะะพะณะธัะพะฒะฐะฝะธะต**: `tracing` + `tracing-subscriber`  
- **ะัะธะฑะบะธ**: `thiserror`  
- **ะััะธ**: `dirs`  

---

## โ ะัะตะธะผััะตััะฒะฐ ะฐััะธัะตะบัััั

- **ะะตะทะพะฟะฐัะฝะพััั ะฟะพ ัะผะพะปัะฐะฝะธั**: ะฝะตะดะพะฒะตัะตะฝะฝัะน ะบะพะด ะธะทะพะปะธัะพะฒะฐะฝ  
- **ะััะพะบะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั**: ะดะพะฒะตัะตะฝะฝัะต ะผะพะดัะปะธ ะฑะตะท IPC  
- **ะญััะตะบัะธะฒะฝะพััั ัะตััััะพะฒ**: ะณััะฟะฟะธัะพะฒะบะฐ ะฒ workerโั  
- **ะะธะฑะบะพััั**: ะฒัะฑะพั ัััะฐัะตะณะธะธ ะฝะฐ ััะพะฒะฝะต ะผะพะดัะปั  
- **ะกะพะฒะผะตััะธะผะพััั**: ะฟะพะดะดะตัะถะบะฐ WASI, Component Model, sync/async  
- **ะฃะฟัะฐะฒะปัะตะผะพััั**: ะตะดะธะฝัะน ALME-ะธะฝัะตััะตะนั ะดะปั ะฒัะตั ะพะฟะตัะฐัะธะน

---

> **Arcella โ ััะพ ะฝะต ะฟัะพััะพ WASM-ัะฐะฝัะฐะนะผ, ะฐ ะพะฟะตัะฐัะธะพะฝะฝะฐั ััะตะดะฐ ะดะปั ะบะพะผะฟะพะฝะตะฝัะพะฒ ัะปะตะดัััะตะณะพ ะฟะพะบะพะปะตะฝะธั.**