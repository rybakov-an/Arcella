# Arcella: Modular WebAssembly Runtime  
**Легковесный, безопасный и динамичный runtime для компонентов WebAssembly**  
*Вдохновлено OSGi и Apache Karaf • Построено на Wasmtime*

---

## 🎯 Цель

Создать **модульный контейнер времени выполнения**, в котором можно:

- Динамически загружать `.wasm`-компоненты  
- Управлять их жизненным циклом (`install`, `start`, `stop`, `update`, `remove`)  
- Обеспечивать **изоляцию и безопасность по умолчанию**  
- Позволять компонентам взаимодействовать через **типобезопасные интерфейсы**  
- Предоставлять **CLI/Shell** для администрирования  

---

## 🧩 Ключевые принципы архитектуры

1. **Arcella всегда работает как демон**  
2. **Гибридная модель изоляции**:  
   - Доверенные async-модули — в основном tokio-потоке  
   - Недоверенные или sync-модули — в изолированных `arcella-worker` процессах  
3. **Группировка модулей** в worker’ы для эффективного использования ресурсов  
4. **Единая точка управления** через ALME (Arcella Local Management Extensions)  
5. **Поддержка как синхронных (WASI), так и асинхронных (Component Model + WIT) модулей**

---

## 🏗️ Общая архитектура

```
┌───────────────────────────────────────────────────────┐
│                  Arcella (main process)               │
│                                                       │
│  ┌─────────────┐     ┌───────────────────────────┐   │
│  │   ALME      │◄───►│      ArcellaRuntime       │   │
│  │ (Unix sock) │     └─────────────┬─────────────┘   │
│  └─────────────┘                   │                 │
│                                    │                 │
│  ┌────────────────────────────────▼─────────────┐   │
│  │           Trusted Async Modules              │   │
│  │  (запускаются напрямую в основном потоке)    │   │
│  └──────────────────────────────────────────────┘   │
│                                    │                 │
│  ┌────────────────────────────────▼─────────────┐   │
│  │            WorkerManager                     │   │
│  └───────┬───────────────────────┬──────────────┘   │
│          │                       │                  │
│  ┌───────▼──────┐        ┌───────▼──────┐          │
│  │ arcella-     │        │ arcella-     │          │
│  │ worker       │        │ worker       │          │
│  │ (group=core) │        │ (group=ext)  │          │
│  └───────┬──────┘        └───────┬──────┘          │
│          │                       │                  │
│  ┌───────▼──────┐        ┌───────▼──────┐          │
│  │ Module A     │        │ Module X     │          │
│  │ Module B     │        │ Module Y     │          │
│  └──────────────┘        └──────────────┘          │
└─────────────────────────────────────────────────────┘
```

---

## 📦 Типы модулей и изоляция

Каждый модуль описывается в **манифесте** (`arcella.toml`) и может использовать один из режимов изоляции:

| Поле манифеста | Значение | Описание |
|----------------|--------|--------|
| `isolation` | `"main"` | Запуск в основном tokio-потоке Arcella |
| | `"worker"` | Запуск в отдельном процессе `arcella-worker` |
| `trusted` | `true`/`false` | Только `true` разрешено для `isolation = "main"` |
| `async` | `true`/`false` | Требуется `true` для `isolation = "main"` |
| `group` | строка | Имя группы для worker-режима (модули в одной группе делят ресурсы) |

### Пример манифеста
```toml
[module]
name = "http-logger"
version = "0.1.0"
isolation = "main"
trusted = true
async = true
exports = ["logger:log"]
imports = ["wasi:http/incoming-handler@0.2.0"]
```

---

## 🔌 Механизмы взаимодействия

| Сценарий | Механизм | Протокол |
|--------|--------|--------|
| **Main ↔ Main** | Прямые вызовы через `Arc<RwLock<...>>` или `tokio::sync::mpsc` | Rust-типы (zero-cost) |
| **Main ↔ Worker** | IPC через Unix-сокет или stdin/stdout | MessagePack / JSON / Cap’n Proto |
| **Worker ↔ Worker** | Только через Main (рекомендуется) или прямой сокет (опционально) | Тот же, что Main ↔ Worker |

> 💡 Все интерфейсы между модулями **описываются в WIT** и генерируются через `wit-bindgen`.

---

## 🧱 Структура проекта

```
arcella/
├── Cargo.toml
├── src/
│   ├── main.rs                 # Точка входа демона
│   ├── cli/                    # CLI-парсер (arcella shell, install и т.д.)
│   ├── alme/                   # ALME: Unix-сокет сервер и протокол
│   ├── runtime/                # Основной runtime, управление модулями
│   ├── worker/                 # Управление arcella-worker процессами
│   ├── config/                 # Загрузка конфигурации (~/.arcella/cfg/)
│   ├── storage/                # Работа с файлами (~/.arcella/modules/)
│   ├── cache/                  # Кэширование скомпилированных модулей
│   ├── manifest/               # Парсинг arcella.toml и валидация
│   ├── log/                    # Инициализация трассировки
│   └── error.rs                # Общие типы ошибок
│
├── bin/
│   └── arcella-worker.rs       # Отдельный бинарник для изолированных модулей
│
└── docs/
    └── ARCHITECTURE.md         # Этот документ
```

---

## ⚙️ Компоненты

### 1. **ALME (Arcella Local Management Extensions)**
- Unix-сокет: `~/.arcella/alme`
- Принимает команды: `install`, `start`, `stop`, `list`, `status`
- Возвращает JSON-RPC-подобные ответы
- Единственная точка управления runtime’ом

### 2. **ArcellaRuntime**
Центральный оркестратор:
- Хранит карту всех модулей (`HashMap<id, ModuleLocation>`)
- Управляет жизненным циклом
- Создаёт экземпляры в `main` или делегирует в `WorkerManager`

### 3. **WorkerManager**
- Запускает/останавливает процессы `arcella-worker`
- Группирует модули по имени группы
- Обеспечивает IPC с дочерними процессами

### 4. **arcella-worker (отдельный бинарник)**
- Принимает команды от родителя через IPC
- Использует **общий `wasmtime::Engine`** для всех модулей в группе
- Поддерживает `install`, `start`, `stop` внутри процесса
- Может быть синхронным или асинхронным (в зависимости от модулей)

### 5. **Trusted Async Module (в основном потоке)**
- Запускается только если `trusted = true && async = true`
- Использует `wasmtime` в **async-режиме**
- Имеет прямой доступ к другим доверенным модулям
- Поддерживает таймауты и graceful shutdown через `tokio::time::timeout`

---

## 🔒 Безопасность и отказоустойчивость

| Угроза | Защита |
|-------|--------|
| Бесконечный цикл | `store.set_fuel(N)` + ловля `Trap` |
| Блокирующий I/O | Запуск в `worker` + таймаут на IPC |
| Аварийное завершение модуля | Изоляция в процессе → не влияет на демон |
| Утечка памяти | Ограничение памяти через `Config::static_memory_maximum_size()` |
| Недоверенный код | Только в `worker`, без доступа к основному процессу |

---

## 🚀 Жизненный цикл модуля

1. **`install`**  
   - Копирование `.wasm` в `~/.arcella/modules/`  
   - Парсинг `arcella.toml`  
   - Регистрация в `ArcellaRuntime`

2. **`start`**  
   - Если `isolation = "main"` → запуск в основном потоке  
   - Если `isolation = "worker"` → отправка команды в соответствующий `arcella-worker`

3. **`stop`**  
   - Отправка сигнала остановки  
   - Ожидание graceful shutdown (с таймаутом)  
   - Принудительное завершение процесса (если worker)

4. **`update` / `remove`**  
   - Остановка → замена файла → перезапуск (для `update`)

---

## 📅 Дорожная карта (MVP)

| Версия | Фича |
|-------|------|
| v0.1 | Запуск простого WASI-модуля (sync) |
| v0.2 | ALME через Unix-сокет |
| v0.3 | CLI-консоль через ALME |
| v0.4 | Внутреннее логирование |
| v0.5 | Манифест жизненного цикла + WIT |
| v0.6 | Загрузка конфигурации из файлов |
| v0.7 | Управление жизненным циклом через ALME |
| v0.8 | Межкомпонентное взаимодействие |
| v1.0 | Горячее обновление + базовая безопасность + гибридная изоляция |

---

## 🛠 Технологии

- **Язык хоста**: Rust 1.90+  
- **WASM Engine**: `wasmtime` v37+  
- **CLI**: `clap`  
- **Async Runtime**: `tokio`  
- **Сериализация**: `serde` + `serde_json` / `rmp-serde`  
- **Логирование**: `tracing` + `tracing-subscriber`  
- **Ошибки**: `thiserror`  
- **Пути**: `dirs`  

---

## ✅ Преимущества архитектуры

- **Безопасность по умолчанию**: недоверенный код изолирован  
- **Высокая производительность**: доверенные модули без IPC  
- **Эффективность ресурсов**: группировка в worker’ы  
- **Гибкость**: выбор стратегии на уровне модуля  
- **Совместимость**: поддержка WASI, Component Model, sync/async  
- **Управляемость**: единый ALME-интерфейс для всех операций

---

> **Arcella — это не просто WASM-рантайм, а операционная среда для компонентов следующего поколения.**